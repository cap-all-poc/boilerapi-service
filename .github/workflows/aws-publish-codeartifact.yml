name: Publish to AWS CodeArtifact

on:
  push:
    tags:
      - "v*"  # Trigger on version tags

permissions:
  id-token: write        # Required for OIDC
  contents: read         # Required to read repo contents

jobs:
  publish:
    environment: development
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/codeartifact-publish-role
          aws-region: ${{ vars.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Build tools
        run: |
          python -m pip install --upgrade pip build twine

      - name: Build the Package (wheel/sdist)
        run: |
          python -m build

      - name: Download Dependencies from requirements.txt
        run: |
          mkdir deps
          python install -r requirements.txt --dest deps/

      - name: Install Twine and login to CodeArtifact
        run: |
          python -m pip install twine
          aws codeartifact login \
            --tool twine \
            --domain "${{ vars.CA_DOMAIN }}" \
            --domain-owner "${{ vars.AWS_ACCOUNT_ID }}" \
            --repository "${{ vars.CA_REPO }}"

      
      - name: Upload dependencies to CodeArtifact
        run: |
          python -m twine upload --repository codeartifact deps/*

      - name: Publish to CodeArtifact
        run: |
          python -m twine upload --repository codeartifact dist/*